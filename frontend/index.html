<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrameRate: Sub-50ms Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Light background */
        }

        /* Custom scrollbar style for better aesthetics */
        #resultsContainer::-webkit-scrollbar {
            width: 8px;
        }

        #resultsContainer::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 10px;
        }

        #resultsContainer::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white shadow-2xl rounded-xl w-full max-w-2xl p-6 md:p-10 border border-gray-100">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">
                FrameRateðŸŽ¬
            </h1>
            <p class="mt-2 text-lg text-gray-500">
                Top 10 Film Recommendations in under 50ms.
            </p>
        </header>

        <div class="space-y-4">
            <label for="userId" class="block text-sm font-medium text-gray-700">
                Enter User ID (Try 1 to 600)
            </label>
            <input type="number" id="userId" value="1" min="1" max="600"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg"
                placeholder="e.g., 42">

            <button id="recommendBtn"
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition duration-200 ease-in-out shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center">
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Get Recommendations
            </button>
        </div>

        <div id="statusMessage" class="mt-6 text-center text-sm font-medium h-6">
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">
            Top Recommendations
        </h2>
        <div id="resultsContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2">
            <p class="text-gray-500 text-center py-4" id="initialMessage">Enter a User ID and click the button above to
                see personalized film recommendations.</p>
        </div>

    </div>

    <script>
        // Use the API service running in the adjacent Docker container (port 8000)
        const API_URL = "http://localhost:8000";
        const recommendBtn = document.getElementById("recommendBtn");
        const userIdInput = document.getElementById("userId");
        const resultsContainer = document.getElementById("resultsContainer");
        const statusMessage = document.getElementById("statusMessage");
        const initialMessage = document.getElementById("initialMessage");
        const loadingSpinner = document.getElementById("loadingSpinner");

        /**
         * Converts predicted rating to a formatted string.
         * @param {number} score - The predicted rating.
         * @returns {string} Formatted rating string.
         */
        function formatRating(score) {
            const roundedScore = score.toFixed(2);
            let color = 'text-gray-600';
            if (score >= 4.0) {
                color = 'text-green-600';
            } else if (score >= 3.0) {
                color = 'text-yellow-600';
            } else {
                color = 'text-red-600';
            }
            return `<span class="font-bold ${color}">${roundedScore}</span>`;
        }

        /**
         * Displays a temporary message in the status area.
         * @param {string} msg - The message to display.
         * @param {string} color - Tailwind color class for the text.
         */
        function showStatus(msg, color = 'text-gray-500') {
            statusMessage.innerHTML = `<span class="${color}">${msg}</span>`;
        }

        /**
         * Handles the click event for the recommendation button.
         */
        async function getRecommendations() {
            const userId = userIdInput.value;

            if (!userId) {
                showStatus("Please enter a User ID.", "text-red-600");
                return;
            }

            // Disable button and show loading state
            recommendBtn.disabled = true;
            recommendBtn.classList.add("opacity-60", "cursor-not-allowed");
            loadingSpinner.classList.remove("hidden");
            showStatus(`Fetching recommendations for User ID ${userId}...`);
            resultsContainer.innerHTML = '';
            initialMessage.style.display = 'none';

            const startTime = performance.now();

            try {
                // In api.py, we defined the endpoint as a POST with a body: @app.post("/recommend", ...)
                // However, for simplicity in the frontend, let's adjust the call to use the /recommend path
                // and send the user_id in the body, as defined by the FastAPI schema.
                const response = await fetch(`${API_URL}/recommend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });

                if (!response.ok) {
                    // Read the error detail from the response body if available
                    const errorDetail = await response.json();
                    const detail = errorDetail.detail || `HTTP error! Status: ${response.status}`;
                    throw new Error(detail);
                }

                const data = await response.json();
                const endTime = performance.now();
                const latency = (endTime - startTime).toFixed(1);

                // Update status message with latency
                const latencyColor = latency <= 50 ? 'text-green-600' : 'text-orange-600';
                showStatus(`Recommendations fetched in <span class="${latencyColor} font-bold">${latency}ms</span> (Target: <50ms)`);

                // Render results
                if (data.recommendations && data.recommendations.length > 0) {
                    data.recommendations.forEach((rec, index) => {
                        const recElement = document.createElement('div');
                        recElement.className = "p-3 bg-white rounded-lg shadow-sm flex justify-between items-center transition duration-150 ease-in-out hover:bg-indigo-50 border-l-4 border-indigo-400";
                        recElement.innerHTML = `
                            <div class="text-gray-800">
                                <span class="text-sm font-semibold text-indigo-600 mr-2">${index + 1}.</span>
                                <span class="text-base">${rec.title}</span>
                            </div>
                            <div class="text-sm font-mono">
                                Pred. Rating: ${formatRating(rec.predicted_rating)}
                            </div>
                        `;
                        resultsContainer.appendChild(recElement);
                    });
                } else {
                    showStatus("No recommendations found for this user. Try a different ID.", "text-red-600");
                }

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                // The error message now reflects the detail from the API if available
                showStatus(`Error: ${error.message || "Could not connect to API."}`, "text-red-600");
                initialMessage.style.display = 'block'; // Show instructions again if error
            } finally {
                // Re-enable button and hide loading state
                recommendBtn.disabled = false;
                recommendBtn.classList.remove("opacity-60", "cursor-not-allowed");
                loadingSpinner.classList.add("hidden");
            }
        }

        recommendBtn.addEventListener("click", getRecommendations);

        // Allow pressing Enter in the input field
        userIdInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                getRecommendations();
            }
        });
    </script>
</body>

</html>